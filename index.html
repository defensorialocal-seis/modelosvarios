<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modelos</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f9fafb; color: #333; padding: 20px; }
    h1 { text-align: center; color: #2d3748; margin-bottom: 30px; }
    .container { max-width: 1000px; margin: 0 auto; }
    .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; margin-right: 10px; margin-bottom: 15px; transition: transform 0.2s, opacity 0.2s; }
    .btn-new, .btn-save { background: linear-gradient(to right, #6eceda, #3a7bd5); }
    .btn-edit { background: linear-gradient(to right, #4caf50, #388e3c); }
    .btn-delete { background: linear-gradient(to right, #f44336, #d32f2f); }
    .btn-print { background: linear-gradient(to right, #6c757d, #343a40); }
    .btn-cancel { background: #888; }
    .btn:hover { opacity: 0.9; transform: translateY(-2px); }
    .search-bar { margin-bottom: 20px; position: relative; }
    .search-bar input { width: 100%; padding: 12px; padding-left: 40px; border: 1px solid #ccc; border-radius: 6px; }
    .search-bar i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888; }
    .card { background: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid #3a7bd5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .card h3 { color: #2d3748; margin-bottom: 8px; }
    .card p { margin: 5px 0; color: #555; }
    .actions button { padding: 6px 10px; font-size: 12px; margin-right: 5px; }
    .pagination { text-align: center; margin-top: 30px; }
    .pagination button { padding: 8px 12px; margin: 0 3px; border: 1px solid #ddd; background: white; cursor: pointer; transition: background 0.2s, color 0.2s; }
    .pagination button.active { background: #3a7bd5; color: white; border-color: #3a7bd5; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s ease-out; }
    .modal-overlay.open .modal-content { transform: scale(1); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #888; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .loading-indicator { text-align: center; padding: 20px; color: #555; display: none; }

    /* Estilos del editor de texto Quill */
    #body-editor {
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      min-height: 300px;
      font-size: 16px;
      padding: 10px;
    }
    .ql-toolbar.ql-snow {
      border-radius: 5px 5px 0 0;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>
<body>

  <div class="container">
    <h2>Modelos Varios Defensoría Civil y Comercial 6 Poder Judicial de Misiones</h2>

    <div class="search-bar">
      <i>🔍</i>
      <input type="text" id="searchInput" placeholder="Buscar por título, temática, proceso, ley o contenido...">
    </div>

    <button class="btn btn-new" id="newModelBtn">Nuevo Modelo</button>

    <div id="loading" class="loading-indicator">Cargando modelos...</div>
    <div id="modelsList"></div>
    <div id="pagination" class="pagination"></div>
  </div>

  <div id="modalOverlay" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Nuevo Escrito</h2>
        <button class="close-btn" id="closeModalBtn">&times;</button>
      </div>
      <form id="modelForm">
        <input type="hidden" id="modelId">
        <div class="form-group">
          <label for="title">Título del Modelo *</label>
          <input type="text" id="title" name="title" required>
        </div>
        <div class="form-group">
          <label for="thematic">Temática *</label>
          <select id="thematic" name="thematic" required>
            <option value="">Selecciona...</option>
            <option value="Civil">Civil</option>
            <option value="Penal">Penal</option>
            <option value="Laboral">Laboral</option>
            <option value="Familiar">Familiar</option>
            <option value="Administrativo">Administrativo</option>
            <option value="Tributario">Tributario</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="process">Proceso *</label>
          <select id="process" name="process" required>
            <option value="">Selecciona...</option>
            <option value="Demanda">Demanda</option>
            <option value="Contestación">Contestación</option>
            <option value="Recurso de Apelación">Recurso de Apelación</option>
            <option value="Recurso de Casación">Recurso de Casación</option>
            <option value="Recurso Extraordinario">Recurso Extraordinario</option>
            <option value="Acta">Acta</option>
            <option value="Constancia">Constancia</option>
            <option value="Cedula">Cedula</option>
            <option value="Cedula Ley 22172">Cedula Ley 22172</option>
            <option value="Oficio">Oficio</option>
            <option value="Oficio Ley 22172">Oficio Ley 22172</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="law">Ley o Normativa Aplicable</label>
          <input type="text" id="law" name="law" placeholder="Ej. Código Penal, Ley 26.773">
        </div>

        <div class="form-group">
          <label for="body-editor">Cuerpo del Modelo *</label>
          <div id="body-editor" required></div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-print" id="printBtn">Imprimir</button>
          <button type="button" class="btn btn-delete" id="deleteBtn">Eliminar</button>
          <button type="submit" class="btn btn-save">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Configuración de tu proyecto de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAchXP14PPlBLGFdJhQG-ABvCZEvxtExP0",
      authDomain: "modelosvarios6.firebaseapp.com",
      projectId: "modelosvarios6",
      storageBucket: "modelosvarios6.firebasestorage.app",
      messagingSenderId: "1020516092766",
      appId: "1:1020516092766:web:56954ecc35055fff901dcf"
    };

    // Inicializa Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const modelsCollection = db.collection('modelos');

    let models = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let currentSearch = '';

    const elements = {
      modelsList: document.getElementById('modelsList'),
      pagination: document.getElementById('pagination'),
      modalOverlay: document.getElementById('modalOverlay'),
      modalTitle: document.getElementById('modalTitle'),
      modelForm: document.getElementById('modelForm'),
      searchInput: document.getElementById('searchInput'),
      loadingIndicator: document.getElementById('loading'),
      newModelBtn: document.getElementById('newModelBtn'),
      closeModalBtn: document.getElementById('closeModalBtn'),
      printBtn: document.getElementById('printBtn'),
      deleteBtn: document.getElementById('deleteBtn'),
      titleInput: document.getElementById('title'),
      thematicSelect: document.getElementById('thematic'),
      processSelect: document.getElementById('process'),
      lawInput: document.getElementById('law')
    };
    
    // Inicializa el editor de texto Quill
    let quill;
    quill = new Quill('#body-editor', {
        theme: 'snow',
        placeholder: 'Escribe aquí el cuerpo del modelo...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link', 'image'],
                ['clean']
            ]
        }
    });

    // Funciones de la interfaz de usuario
    function showLoading() {
      elements.loadingIndicator.style.display = 'block';
      elements.modelsList.innerHTML = '';
      elements.pagination.innerHTML = '';
    }

    function hideLoading() {
      elements.loadingIndicator.style.display = 'none';
    }

    function openModal(model = null) {
      elements.modelForm.reset();
      document.getElementById('modelId').value = '';
      quill.setContents([]);

      if (model) {
        elements.modalTitle.textContent = 'Editar Modelo';
        document.getElementById('modelId').value = model.id;
        elements.titleInput.value = model.title;
        elements.thematicSelect.value = model.thematic;
        elements.processSelect.value = model.process;
        elements.lawInput.value = model.law || '';
        
        // Cargar contenido en el editor Quill
        quill.clipboard.dangerouslyPasteHTML(model.body || '');
        
        elements.deleteBtn.style.display = 'inline-block';
        elements.printBtn.style.display = 'inline-block';
      } else {
        elements.modalTitle.textContent = 'Nuevo Modelo';
        elements.deleteBtn.style.display = 'none';
        elements.printBtn.style.display = 'none';
      }
      elements.modalOverlay.style.display = 'flex';
    }

    function closeModal() {
      elements.modalOverlay.style.display = 'none';
      elements.modelForm.reset();
    }

    function renderModels() {
      const filtered = models.filter(model =>
        Object.values(model).some(val => 
          val?.toString().toLowerCase().includes(currentSearch.toLowerCase())
        )
      );

      const totalPages = Math.ceil(filtered.length / itemsPerPage);
      const start = (currentPage - 1) * itemsPerPage;
      const currentModels = filtered.slice(start, start + itemsPerPage);

      elements.modelsList.innerHTML = '';
      if (currentModels.length === 0 && currentSearch === '') {
        elements.modelsList.innerHTML = '<p style="text-align:center; color:#888;">No hay modelos registrados. Crea uno nuevo.</p>';
      } else if (currentModels.length === 0 && currentSearch !== '') {
        elements.modelsList.innerHTML = '<p style="text-align:center; color:#888;">No se encontraron resultados para tu búsqueda.</p>';
      } else {
        currentModels.forEach(model => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <h3>${model.title}</h3>
            <p><strong>Temática:</strong> ${model.thematic || 'N/A'}</p>
            <p><strong>Proceso:</strong> ${model.process || 'N/A'}</p>
            <p><strong>Ley:</strong> ${model.law || '-'}</p>
            <div class="actions">
              <button class="btn btn-edit" onclick="editModel('${model.id}')">Ver y Editar</button>
            </div>
          `;
          elements.modelsList.appendChild(card);
        });
      }
      renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
      elements.pagination.innerHTML = '';
      if (totalPages <= 1) return;
      const prevBtn = document.createElement('button');
      prevBtn.textContent = '←';
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => { currentPage--; renderModels(); };
      elements.pagination.appendChild(prevBtn);
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = i === currentPage ? 'active' : '';
        btn.onclick = () => { currentPage = i; renderModels(); };
        elements.pagination.appendChild(btn);
      }
      const nextBtn = document.createElement('button');
      nextBtn.textContent = '→';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => { currentPage++; renderModels(); };
      elements.pagination.appendChild(nextBtn);
    }

    // Funciones de Firebase
    function fetchModels() {
      showLoading();
      modelsCollection.orderBy('title').onSnapshot(snapshot => {
        models = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        hideLoading();
        renderModels();
      }, error => {
        console.error("Error al obtener los documentos: ", error);
        hideLoading();
        elements.modelsList.innerHTML = '<p style="text-align:center; color:#f44336;">Error al cargar los modelos. Por favor, inténtelo de nuevo.</p>';
      });
    }

    async function saveModel() {
      const id = document.getElementById('modelId').value;
      const title = elements.titleInput.value.trim();
      const thematic = elements.thematicSelect.value;
      const process = elements.processSelect.value;
      const law = elements.lawInput.value.trim();
      
      // Obtener el contenido del editor Quill en formato HTML
      const body = quill.root.innerHTML;

      if (!title || !thematic || !process || !body) {
        alert('Los campos Título, Temática, Proceso y Cuerpo del Escrito son obligatorios.');
        return;
      }
      
      const modelData = { title, thematic, process, law, body };

      try {
        if (id) {
          await modelsCollection.doc(id).update(modelData);
        } else {
          await modelsCollection.add(modelData);
        }
        closeModal();
      } catch (e) {
        console.error("Error al guardar el documento: ", e);
        alert("Ocurrió un error al guardar. Por favor, intente de nuevo.");
      }
    }

    async function deleteModel() {
      const id = document.getElementById('modelId').value;
      if (confirm('¿Estás seguro de que quieres eliminar este documento? Esta acción no se puede deshacer.')) {
        try {
          await modelsCollection.doc(id).delete();
          closeModal();
        } catch (e) {
          console.error("Error al eliminar el documento: ", e);
          alert("Ocurrió un error al eliminar. Por favor, intente de nuevo.");
        }
      }
    }

    function editModel(id) {
      const model = models.find(m => m.id === id);
      if (model) {
        openModal(model);
      }
    }

    function printDocument() {
      const modelId = document.getElementById('modelId').value;
      const model = models.find(m => m.id === modelId);
      if (model) {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <html>
            <head>
              <title>${model.title}</title>
              <style>
                body { font-family: Arial, sans-serif; white-space: pre-wrap; padding: 20px; }
                h1 { text-align: center; }
                p { margin: 5px 0; }
              </style>
            </head>
            <body>
              <h1>${model.title}</h1>
              <p><strong>Temática:</strong> ${model.thematic || 'N/A'}</p>
              <p><strong>Proceso:</strong> ${model.process || 'N/A'}</p>
              <p><strong>Ley:</strong> ${model.law || '-'}</p>
              <hr>
              <div>${model.body}</div>
            </body>
          </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
        }, 500);
      }
    }

    // Event listeners
    elements.newModelBtn.addEventListener('click', () => openModal());
    elements.closeModalBtn.addEventListener('click', closeModal);
    elements.printBtn.addEventListener('click', printDocument);
    elements.deleteBtn.addEventListener('click', deleteModel);

    elements.modelForm.addEventListener('submit', function(e) {
      e.preventDefault();
      saveModel();
    });

    elements.searchInput.addEventListener('input', (e) => {
      currentSearch = e.target.value;
      currentPage = 1;
      renderModels();
    });

    // Inicializar la aplicación
    window.onload = fetchModels;
  </script>

</body>
</html>
